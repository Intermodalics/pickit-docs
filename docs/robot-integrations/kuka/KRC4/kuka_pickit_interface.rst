.. _kuka-pickit-interface:

KUKA Pickit interface
=====================

This article documents the interface of the KUKA Pickit integration.
For installation instructions, please refer to the :ref:`kuka-installation-and-setup` article.

Pickit communication functions
------------------------------

Below you find an overview of the functions defined by Pickit that are responsible for communicating with a Pickit system.
For more details on these functions, refer to :ref:`socket-communication`.

+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Function                                     | Comment                                                                                                                                                                                                                                                  | Input arguments | Return type                                                     |
+==============================================+==========================================================================================================================================================================================================================================================+=================+=================================================================+
| Pickit_is_running()                          | Check if Pickit is set to :ref:`Robot mode <web-interface-top-bar>`.                                                                                                                                                                                     | /               | Boolean                                                         |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_do_calibration()                      | Trigger a detection of the robot-camera calibration plate.                                                                                                                                                                                               | /               | /                                                               |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_look_for_object()                     | Trigger a Pickit object detection using the currently active setup and product :ref:`Configuration`.                                                                                                                                                     | /               | /                                                               |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_detect_with_retr (LZ_Retries:IN)      | Repeatedly trigger a Pickit object detection as long as nothing is found and the ROI is not empty, up to a number of attempts.                                                                                                                           | retries         | /                                                               |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_capture_image()                       | Trigger Pickit to capture a camera image to be used by a following **Pickit_process_image()** function.                                                                                                                                                  | /               | /                                                               |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_process_image()                       | Trigger an object detection on the camera image that was previously captured via the **Pickit_capture_image()** function (or one of the **Detection** functions).                                                                                        | /               | /                                                               |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_next_object()                         | Request the next detected object.                                                                                                                                                                                                                        | /               | /                                                               |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_configure (LZ_Setup:IN,LZ_Product:IN) | Load the specified setup and product :ref:`Configuration`.                                                                                                                                                                                               | setup, product  | /                                                               |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_save_scene()                          | Save a :ref:`Snapshots` with the latest detection results.                                                                                                                                                                                               | /               | /                                                               |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_build_bkg_cloud()                     | Build the background cloud used in :ref:`advanced-roi-filters`.                                                                                                                                                                                          | /               | /                                                               |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_gppd()                                | Request the pick point ID and pick point offset of the last requested object.                                                                                                                                                                            | /               | / - (Some Pickit variables are updated in the background)       |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_has_response()                        | Wait for Pickit reply with detection results. **Pickit_has_response()** should always be the next Pickit function after a **Pickit_look_for_object()**, **Pickit_next_object()**, **Pickit_detect_with_retr(..)** or **Pickit_process_image()** request. | /               | Boolean - (Some Pickit variables are updated in the background) |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+
| Pickit_get_results()                         | Combination of **Pickit_has_response()** and **Pickit_gppd()** function. It is advised to use this function when working with Pickit version 2.2 onwards.                                                                                                | /               | Boolean - (All Pickit variables are updated in the background)  |
+----------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------------------------------------------------------+

Using the Pickit functions with return value
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Some Pickit functions mentioned above have a return value.
These functions are used in the program in a different way than the other functions.
See :ref:`kuka-example-picking-program` on how they are typically implemented in a robot program.

Pickit helper functions
-----------------------

Following functions don't communicate with a Pickit system but are functions that make your robot program more readable.
The return value of these functions is a boolean and the status of the return value gets updated after using the Pickit function **Pickit_has_response()** or **Pickit_get_results()**.
See :ref:`kuka-example-picking-program` on how they are typically implemented in a robot program.

+----------------------------+--------------------------------------------------------------------------------+
| Function                   | Comment                                                                        |
+============================+================================================================================+
| Pickit_object_found()      | Returns if Pickit found an object.                                             |
+----------------------------+--------------------------------------------------------------------------------+
| Pickit_no_image_captured() | Returns if an image is captured by Pickit, if not check the camera connection. |
+----------------------------+--------------------------------------------------------------------------------+
| Pickit_roi_empty()         | Returns if the ROI is empty.                                                   |
+----------------------------+--------------------------------------------------------------------------------+

Pickit output functions
-----------------------

Following functions are used to get the output values of Pickit after triggering a detection.
The output values are updated after using the Pickit function **Pickit_has_response()** or **Pickit_get_results()**.

+----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+-------------+
| Function                   | Comment                                                                                                                                 | Return type |
+============================+=========================================================================================================================================+=============+
| Pickit_get_pose()          | Object pose expressed relatively to the robot base frame.                                                                               | FRAME       |
+----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+-------------+
| Pickit_get_offset()        | Pick point offset of the last requested object.                                                                                         | FRAME       |
+----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+-------------+
| Pickit_object_type()       | - For a :ref:`Teach` detection, ID type of the detected object.                                                                         | INT         |
|                            | - For a :ref:`Flex`/:ref:`Pattern` detection, the object type of the detected object.                                                   |             |
+----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+-------------+
| Pickit_object_pick_id()    | ID of the pick point that was selected for the given object.                                                                            | INT         |
+----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+-------------+
| Pickit_object_age()        | Amount of time that has passed between the capturing of the camera data and the moment the object information is sent to the robot (s). | REAL        |
+----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+-------------+
| Pickit_object_dim_1()      | Length or diameter (mm).                                                                                                                | REAL        |
+----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+-------------+
| Pickit_object_dim_2()      | Width or diameter (mm).                                                                                                                 | REAL        |
+----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+-------------+
| Pickit_object_dim_3()      | Height (mm).                                                                                                                            | REAL        |
+----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+-------------+
| Pickit_object_ref_id()     | ID of the selected pick point’s reference pick point.                                                                                   | INT         |
+----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+-------------+
| Pickit_remaining_objects() | Number of remaining objects that can be sent to the robot in the next messages.                                                         | INT         |
+----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+-------------+

Using pick offset in a robot program
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To use the **pick offset** in a robot program, first a fixed pose has to be taught.
Then the offset can be applied to this fixed pose to correct from picking with an offset.
Following example shows how the pose **Dropit** is corrected: 
::

  drop_offset = Pickit_get_offset()
  F_drop_correct = Dropit:drop_offset
  PTP F_drop_correct